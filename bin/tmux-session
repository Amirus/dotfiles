#!/usr/bin/env bash
# Save and restore the state of tmux sessions and windows.
# TODO: persist and restore the state & position of panes.
set -e

dump() {
  local d=$'\t'
  tmux list-windows -a -F "#S${d}#W${d}#{pane_current_path}"
}

save() {
  dump > ~/.tmux-session
}

terminal_size() {
  stty size 2>/dev/null | awk '{ printf "-x%d -y%d", $2, $1 }'
}

restore() {
  tmux start-server
  local count=0
  local dimensions="$(terminal_size)"

  while IFS=$'\t' read session_name window_name dir; do
    if ! [[ $window_name = "log" || $window_name = "man" ]]; then
      if tmux has-session -t "$session_name" 2>/dev/null; then
        tmux new-window -d -n "$window_name" -t "${session_name}:"
      else
        tmux new-session -d -s "$session_name" -n "$window_name" $dimensions
        count=$(( $count + 1 ))
      fi
      tmux send-keys -t "${session_name}:$" "cd '${dir}'; clear" C-m
    fi
  done < ~/.tmux-session

  echo "restored $count sessions"
}

case "$1" in
save | restore )
  $1
  ;;
* )
  echo "valid commands: save, restore" >&2
  exit 1
esac
